library(readxl)
library(forecast)
library(lmtest)
library(LSTS)
library(ggplot2)
library(MASS)
df <- read_excel("stock de cartera consumo normal.xlsx", skip = 3)
df$Fecha <- as.Date(df$Fecha)
df$`Banco de Chile` <- as.numeric(gsub(",", ".", df$`Banco del Estado de Chile`))
serie <- ts(df$`Banco del Estado de Chile`,
start = c(2011, 1),
end = c(2025, 5),
frequency = 12)
n       <- length(serie)
n_train <- floor(n * 0.9)
serie_train <- subset(serie, end   = n_train)
serie_test  <- subset(serie, start = n_train + 1)
#----------------------------------------------------------
ndiffs(serie_train)
acf(serie_train, lag.max = 30)
pacf(serie_train, lag.max = 30)
BoxCox.lambda(serie_train)
acf(serie_train, lag.max = 30)
pacf(serie_train, lag.max = 30)
lambda  <- BoxCox.lambda(serie_train)
acf(serie_train, lag.max = 30)
pacf(serie_train, lag.max = 30)
modelo <- auto.arima(serie_train,
seasonal = TRUE, lambda = lambda, biasadj = TRUE)
summary(modelo)
modelo <- auto.arima(serie_train,
seasonal = TRUE, lambda = lambda)
summary(modelo)
plot(serie)
summarry(serie)
summary(serie)
plot(serie)
#----------------------------------------------------------
ndiffs(serie_train)
plot(diff(serie_train))
acf(serie_train, lag.max = 30)
pacf(serie_train, lag.max = 30)
modelo <- auto.arima(serie_train,
seasonal = TRUE)
summary(modelo)
run_diagnostics <- function(fit, name, alpha = 0.05) {
cat("\n==============================\n")
cat("DIAGNÓSTICOS PARA:", name, "\n")
cat("==============================\n")
res <- residuals(fit)
res <- as.numeric(res)
t   <- 1:length(res)
# Box-Ljung
cat("\n--- Box-Ljung ---\n")
bj <- LSTS::Box.Ljung.Test(res, lag = 30)
print(bj)
# Breusch-Pagan
cat("\n--- Breusch-Pagan ---\n")
bp <- lmtest::bptest(res ~ t)
print(bp)
# Shapiro-Wilk
cat("\n--- Shapiro-Wilk ---\n")
# Shapiro no acepta n muy grande; si tu serie es enorme, puedes muestrear:
if (length(res) <= 5000) {
sw <- shapiro.test(res)
} else {
sw <- shapiro.test(sample(res, 5000))
}
print(sw)
# KS vs Normal
cat("\n--- Kolmogorov-Smirnov ---\n")
ks <- ks.test(
res,
"pnorm",
mean = mean(res, na.rm = TRUE),
sd   = sd(res, na.rm = TRUE)
)
print(ks)
invisible(list(
BoxLjung = bj,
BP       = bp,
Shapiro  = sw,
KS       = ks
))
}
diag_M1 <- run_diagnostics(modelo, "mati weko")
acf(modelo$residuals^2)
res <- residuals(modelo)
res <- as.numeric(res)
fit_t <- fitdistr(res, densfun = "t")
acf(modelo$residuals^2, lag.max = 36)
res <- residuals(modelo)
res <- as.numeric(res)
fit_t <- fitdistr(res, densfun = "t")
nu    <- fit_t$estimate["df"]
mu    <- fit_t$estimate["m"]
sigma <- fit_t$estimate["s"]
res_std <- (res - mu) / sigma
ks.test(res_std, "pt", df = nu)
coefs <- coef(modelo)
ses   <- sqrt(diag(modelo$var.coef))
tvals <- abs(coefs / ses)
tvals
h <- length(serie_test)
fc_x <- forecast(
modelo,
h    = h
)
accuracy(fc_x, serie_test)
pred <- as.numeric(fc_x$mean)
lo80 <- as.numeric(fc_x$lower[,1])
hi80 <- as.numeric(fc_x$upper[,1])
lo95 <- as.numeric(fc_x$lower[,2])
hi95 <- as.numeric(fc_x$upper[,2])
tt <- 1:length(serie_test)
yr <- range(c(serie_test, lo95, hi95), na.rm = TRUE)
par(bty = "n")
plot(tt, serie_test, type = "l", lwd = 1,
ylim = yr, xlab = "Tiempo (índice en test)", ylab = "serie",
main = "Validación SARIMAX")
polygon(
c(tt, rev(tt)),
c(hi95, rev(lo95)),
col = rgb(0, 0, 1, 0.15), border = NA
)
polygon(
c(tt, rev(tt)),
c(hi80, rev(lo80)),
col = rgb(0, 0, 1, 0.30), border = NA
)
lines(tt, y_test, col = "black", lwd = 1)
lines(tt, serie_test, col = "black", lwd = 1)
lines(tt, pred,  col = "red",   lwd = 1)
legend(
"topright",
legend = c("Predicción", "IC 80%", "IC 95%"),
col    = c("red", rgb(0,0,1,0.30), rgb(0,0,1,0.15)),
lwd    = c(2,10,10),
bty    = "n"
)
legend(
"bottomleft",
legend = c("Predicción", "IC 80%", "IC 95%"),
col    = c("red", rgb(0,0,1,0.30), rgb(0,0,1,0.15)),
lwd    = c(2,10,10),
bty    = "n"
)
pred <- as.numeric(fc_x$mean)
lo80 <- as.numeric(fc_x$lower[,1])
hi80 <- as.numeric(fc_x$upper[,1])
lo95 <- as.numeric(fc_x$lower[,2])
hi95 <- as.numeric(fc_x$upper[,2])
tt <- 1:length(serie_test)
yr <- range(c(serie_test, lo95, hi95), na.rm = TRUE)
par(bty = "n")
plot(tt, serie_test, type = "l", lwd = 1,
ylim = yr, xlab = "Tiempo (índice en test)", ylab = "serie",
main = "Validación SARIMAX")
polygon(
c(tt, rev(tt)),
c(hi95, rev(lo95)),
col = rgb(0, 0, 1, 0.15), border = NA
)
polygon(
c(tt, rev(tt)),
c(hi80, rev(lo80)),
col = rgb(0, 0, 1, 0.30), border = NA
)
lines(tt, serie_test, col = "black", lwd = 1)
lines(tt, pred,  col = "red",   lwd = 1)
legend(
"bottomleft",
legend = c("Predicción", "IC 80%", "IC 95%"),
col    = c("red", rgb(0,0,1,0.30), rgb(0,0,1,0.15)),
lwd    = c(2,10,10),
bty    = "n"
)
accuracy(fc_x, serie_test)
